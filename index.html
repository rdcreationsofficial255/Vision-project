<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project VISION AI - AIMI Navigator</title>
<style>
body { margin:0; font-family:'Segoe UI',Tahoma,Verdana,sans-serif; background:#111; color:#fff; text-align:center; padding:15px;}
h2 { font-size:28px; margin-bottom:5px; color:#00e676;}
p { font-size:16px; color:#aaa; margin-bottom:20px;}
textarea, input, button { display:block; width:90%; margin:10px auto; border-radius:12px; font-size:18px; padding:12px; border:none; outline:none;}
textarea { height:120px; background:#222; color:#fff; border:2px solid #333; }
input { height:45px; background:#222; color:#fff; border:2px solid #333; }
button { background:linear-gradient(90deg,#00e676,#1de9b6); color:#000; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.3);}
button:active { transform:scale(0.98); box-shadow:0 2px 6px rgba(0,0,0,0.3);}
video { width:90%; margin-top:15px; border-radius:15px; display:none; border:2px solid #00e676;}
.log { margin-top:20px; font-size:16px; color:#aaa;}
</style>
</head>
<body>

<h2>ðŸ¦¯ Project VISION AI</h2>
<p>Voice â€¢ Text Reader â€¢ Obstacle Detection â€¢ GPS Navigation</p>

<textarea id="textBox" placeholder="Type or paste text here..."></textarea>
<button onclick="readText()">ðŸ”Š Read Text</button>
<button onclick="voiceButtonPress('voice')">ðŸŽ¤ Voice Command</button>
<button onclick="voiceButtonPress('camera')">ðŸ“· Vision / Navigator Mode</button>
<input type="text" id="destinationInput" placeholder="Enter destination (e.g., Home)">
<button onclick="voiceButtonPress('navigate')">ðŸ§­ Start Navigation</button>

<video id="camera" autoplay playsinline></video>
<div class="log" id="log">Waiting for input...</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
// ===================== AIMI INTRO =======================
function aimiIntro(){
  speak("Hello, I'm AIMI. I'm here to assist you safely. You can ask me to read text, start navigation, or activate vision mode.");
}
window.onload = aimiIntro;

// ===================== GLOBAL VARIABLES =================
let cameraOn=false, video=document.getElementById("camera"), model=null, detecting=false, audioContext, lastAlertTime=0;
let navigationOn=false, targetLat=null, targetLon=null, currentPosition=null;

// Real obstacles only (ignore small/unnecessary items)
const obstacleClasses=['person','chair','sofa','table','bed','couch','potted plant','tv','refrigerator','door','wall','car','bicycle','motorcycle'];
let previousClass=null, consecutiveCount=0;

// ===================== AI VOICE =========================
function speak(text){
  const msg=new SpeechSynthesisUtterance(text);
  msg.lang='en-IN'; msg.rate=1;
  window.speechSynthesis.speak(msg);
  document.getElementById("log").innerText=text;
}

// ===================== TEXT READER ======================
function readText(){
  const txt=document.getElementById("textBox").value.trim();
  if(!txt){ speak("Please type some text first."); return; }
  speak(txt);
}

// ===================== VOICE BUTTON ====================
function voiceButtonPress(action){
  if(action==='voice') startListening();
  else if(action==='camera') toggleCamera();
  else if(action==='navigate') startNavigation();
}

// ===================== VOICE RECOGNITION ==============
function startListening(){
  speak("Listening for your command.");
  try{
    const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SpeechRecognition){ speak("Voice recognition not supported."); return; }
    const rec=new SpeechRecognition();
    rec.lang='en-IN';
    rec.onresult=function(e){
      const cmd=e.results[0][0].transcript.toLowerCase();
      speak("You said: "+cmd);
      handleCommand(cmd);
    };
    rec.start();
  }catch(e){ speak("Voice recognition not supported."); }
}

function handleCommand(cmd){
  if(cmd.includes("read")) readText();
  else if(cmd.includes("clear")){ document.getElementById("textBox").value=""; speak("Text cleared."); }
  else if(cmd.includes("camera")||cmd.includes("vision")||cmd.includes("navigator")) toggleCamera();
  else if(cmd.includes("navigate to")){ document.getElementById("destinationInput").value=cmd.replace("navigate to","").trim(); startNavigation(); }
  else speak("Command not recognized.");
}

// ===================== CAMERA / OBJECT DETECTION =======
async function toggleCamera(){
  if(!cameraOn){
    try{
      video.style.display="block";
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject=stream;
      speak("Loading vision model...");
      model=await cocoSsd.load();
      speak("Vision ready. I will alert for real obstacles.");
      cameraOn=true; detecting=true; detectObjects();
    }catch(e){ speak("Cannot access camera."); console.error(e);}
  }else stopCamera();
}

function stopCamera(){ 
  if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop()); 
  video.style.display="none"; cameraOn=false; detecting=false; 
  speak("Camera turned off."); 
}

async function detectObjects(){
  if(!model||!detecting) return;
  const preds=await model.detect(video);
  if(preds.length>0){
    const top=preds[0];
    if(obstacleClasses.includes(top.class)){
      // Require two consecutive frames for reliability
      if(top.class === previousClass) consecutiveCount++;
      else consecutiveCount=1;
      previousClass=top.class;

      if(consecutiveCount>=2){
        const area=top.bbox[2]*top.bbox[3];
        const distance=getDistanceFromArea(area);
        if(Date.now()-lastAlertTime>3000){
          if(distance<0.5) speak("Stop! Obstacle very close, turn left slowly.");
          else if(distance<1) speak("Obstacle ahead, move slowly.");
          else speak("Obstacle detected ahead, continue carefully.");
          playBeep(distance<0.5?300:700);
          lastAlertTime=Date.now();
        }
      }
    }
  }
  requestAnimationFrame(detectObjects);
}

function getDistanceFromArea(area){
  if(area>120000) return 0.3;
  if(area>60000) return 0.6;
  if(area>20000) return 1.0;
  return 2.0;
}

function playBeep(freq){ 
  if(!audioContext) audioContext=new AudioContext(); 
  const osc=audioContext.createOscillator(); 
  const gain=audioContext.createGain(); 
  osc.connect(gain); gain.connect(audioContext.destination); 
  osc.type="sine"; osc.frequency.value=freq; osc.start(); 
  gain.gain.exponentialRampToValueAtTime(0.0001,audioContext.currentTime+0.3); 
}

// ===================== GPS NAVIGATION =================
function startNavigation(){
  const dest=document.getElementById("destinationInput").value.trim();
  if(!dest){ speak("Enter a destination first."); return; }
  navigationOn=true;
  speak(`Navigation started to ${dest}`);
  trackPosition(dest);
}

function trackPosition(dest){
  if(!navigationOn) return;
  if(!navigator.geolocation){ speak("Geolocation not supported."); return; }

  navigator.geolocation.getCurrentPosition(pos=>{
    currentPosition=pos.coords;
    const lat=currentPosition.latitude, lon=currentPosition.longitude;

    // Demo destinations
    if(dest.toLowerCase()=="home"){ targetLat=12.9716; targetLon=77.5946; }
    else if(dest.toLowerCase()=="school"){ targetLat=12.9750; targetLon=77.5920; }
    else{ targetLat=lat; targetLon=lon; speak("Unknown destination. Using current location."); }

    const dist=calculateDistance(lat,lon,targetLat,targetLon);
    if(dist<0.01){ speak(`You have arrived at ${dest}`); navigationOn=false; return; }
    const direction=getDirection(lat,lon,targetLat,targetLon);
    speak(`Move ${direction}. Distance: ${(dist*1000).toFixed(0)} meters.`);
    setTimeout(()=>trackPosition(dest),5000);
  }, ()=>speak("Unable to get GPS location."));
}

function calculateDistance(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }
function getDirection(lat1,lon1,lat2,lon2){ const dLon=lon2-lon1; const y=Math.sin(dLon*Math.PI/180)*Math.cos(lat2*Math.PI/180); const x=Math.cos