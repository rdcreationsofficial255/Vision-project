<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project VISION - Full Navigator</title>
<style>
body { background-color:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; padding:25px; }
h2 { font-size:24px; margin-bottom:10px; }
button, input, textarea { display:block; width:85%; margin:10px auto; padding:15px; font-size:18px; border-radius:10px; border:none; background-color:#007bff; color:#fff; }
button:active { background-color:#0056b3; }
textarea { height:120px; border:2px solid #555; background:#111; color:#fff; }
video { width:90%; border-radius:15px; margin-top:15px; display:none; }
.log { margin-top:20px; font-size:16px; color:#ccc; }
</style>
</head>
<body>
<h2>ðŸ¦¯ Project VISION</h2>
<p>Voice â€¢ Text Reader â€¢ Object Detection â€¢ GPS Navigation</p>

<textarea id="textBox" placeholder="Type or paste text here..."></textarea>
<button onclick="readText()">ðŸ”Š Read Text</button>
<button onclick="startListening()">ðŸŽ¤ Voice Command</button>
<button onclick="toggleCamera()">ðŸ“· Vision / Navigator Mode</button>
<input type="text" id="destinationInput" placeholder="Enter destination name (e.g., Home)">
<button onclick="startNavigation()">ðŸ§­ Start Navigation</button>

<video id="camera" autoplay playsinline></video>
<div class="log" id="log">Waiting for input...</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
let cameraOn=false, video=document.getElementById("camera"), model=null, detecting=false, audioContext, lastAlertTime=0;
let navigationOn=false, targetLat=null, targetLon=null;

// === SPEAK ===
function speak(text){
  const msg=new SpeechSynthesisUtterance(text);
  msg.lang='en-IN'; msg.rate=1;
  window.speechSynthesis.speak(msg);
  document.getElementById("log").innerText="Speaking: "+text;
}

// === TEXT READER ===
function readText(){
  const text=document.getElementById("textBox").value.trim();
  if(text==="") speak("Please type or paste something first.");
  else speak(text);
}

// === VOICE COMMAND ===
function startListening(){
  document.getElementById("log").innerText="Listening...";
  try{
    const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SpeechRecognition){ speak("Voice recognition not supported."); return; }
    const rec=new SpeechRecognition();
    rec.lang='en-IN';
    rec.onresult=function(e){
      const command=e.results[0][0].transcript.toLowerCase();
      document.getElementById("log").innerText="You said: "+command;
      handleCommand(command);
    };
    rec.start();
  }catch(e){ speak("Speech recognition not supported."); }
}

function handleCommand(cmd){
  if(cmd.includes("read")) readText();
  else if(cmd.includes("clear")){ document.getElementById("textBox").value=""; speak("Text cleared."); }
  else if(cmd.includes("vision")||cmd.includes("camera")||cmd.includes("navigator")) toggleCamera();
  else if(cmd.includes("stop")) stopAll();
  else if(cmd.includes("navigate to")){ document.getElementById("destinationInput").value=cmd.replace("navigate to ",""); startNavigation(); }
  else speak("Command not recognized.");
}

// === CAMERA CONTROL ===
async function toggleCamera(){
  if(!cameraOn){
    try{
      video.style.display="block";
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject=stream;
      speak("Loading vision model...");
      model=await cocoSsd.load();
      speak("Vision ready. I will alert for nearby objects.");
      cameraOn=true; detecting=true; detectObjects();
    }catch(err){ speak("Camera access failed."); console.error(err); }
  }else stopCamera();
}

function stopCamera(){ if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop()); video.style.display="none"; cameraOn=false; detecting=false; speak("Camera off."); }

// === DETECTION + DISTANCE ALERTS ===
async function detectObjects(){
  if(!model||!detecting) return;
  const predictions=await model.detect(video);
  if(predictions.length>0){
    const top=predictions[0], size=top.bbox[2]*top.bbox[3], distance=getDistanceFromArea(size);
    if(Date.now()-lastAlertTime>3000){
      if(distance<0.5){ speak(`Warning! ${top.class} very close.`); playBeep(300); }
      else if(distance<1){ speak(`Object ahead: ${top.class}`); playBeep(700); }
      else speak(`I see a ${top.class} far ahead.`); lastAlertTime=Date.now();
    }
  }
  requestAnimationFrame(detectObjects);
}
function getDistanceFromArea(area){ if(area>80000) return 0.3; if(area>40000) return 0.6; if(area>15000) return 1.0; return 2.0; }
function playBeep(freq){ if(!audioContext) audioContext=new AudioContext(); const osc=audioContext.createOscillator(); const gain=audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); osc.type="sine"; osc.frequency.value=freq; osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001,audioContext.currentTime+0.3); }

// === GPS NAVIGATION ===
function startNavigation(){
  const dest=document.getElementById("destinationInput").value.trim();
  if(!dest){ speak("Enter destination name."); return; }
  navigationOn=true; speak(`Navigation started to ${dest}`);
  trackPosition(dest);
}

function stopAll(){ navigationOn=false; stopCamera(); speak("All functions stopped."); }

function trackPosition(dest){
  if(!navigationOn) return;
  if(!navigator.geolocation){ speak("Geolocation not supported."); return; }

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    if(dest.toLowerCase()==="home"){ targetLat=12.9716; targetLon=77.5946; }
    else if(dest.toLowerCase()==="school"){ targetLat=12.9750; targetLon=77.5920; }
    else { targetLat=lat; targetLon=lon; speak("Destination unknown. Using current location."); }

    const distance=getDistance(lat,lon,targetLat,targetLon);
    if(distance<0.01){ speak(`You have arrived at ${dest}`); navigationOn=false; return; }
    const direction=getDirection(lat,lon,targetLat,targetLon);
    speak(`Move ${direction}. Distance: ${(distance*1000).toFixed(0)} meters.`);

    setTimeout(()=>trackPosition(dest),5000);
  },()=>speak("Unable to get GPS location."));
}

function getDistance(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }
function getDirection(lat1,lon1,lat2,lon2){ const dLon=lon2-lon1; const y=Math.sin(dLon*Math.PI/180)*Math.cos(lat2*Math.PI/180); const x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon*Math.PI/180); const brng=Math.atan2(y,x)*180/Math.PI; if(brng<0) return `${Math.round(brng+360)}Â° clockwise`; return `${Math.round(brng)}Â° clockwise`; }
</script>
</body>
</html>